<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanif Ridho Abdillah - Indonesian Geological Research</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007ac2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='2' y1='12' x2='22' y2='12'%3E%3C/line%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'%3E%3C/path%3E%3C/svg%3E">
    
    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the dashboard */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
        }
        #main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #top-row {
             /* height: 60vh; Default height is now controlled by JS */
             display: flex;
             flex-grow: 1;
             min-height: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            background-color: #f8f8f8;
        }
        #table-container-wrapper {
            /* height: 40vh; Default height is now controlled by JS */
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Prevent this from shrinking */
        }
        #info-panel-container::-webkit-scrollbar { width: 8px; }
        #info-panel-container::-webkit-scrollbar-track { background: #f1f1f1; }
        #info-panel-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        #info-panel-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* DataTables custom styling */
        .dataTables_wrapper .dataTables_scrollBody {
             border-top: 1px solid #e5e7eb;
             border-bottom: 1px solid #e5e7eb;
        }
        
        /* Leaflet Controls Styling */
        .leaflet-control-layers { border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .leaflet-control-attribution { font-size: 10px !important; }
        
        /* Resizer styles */
        .resizer-v {
            background-color: #e5e7eb;
            cursor: row-resize;
            height: 8px;
            flex-shrink: 0;
        }
        .resizer-h {
            background-color: #e5e7eb;
            cursor: col-resize;
            width: 8px;
            flex-shrink: 0;
        }
        .resizer-v:hover, .resizer-h:hover {
            background-color: #007ac2;
        }
    </style>
</head>
<body class="text-gray-700">
    <!-- Header -->
    <header class="bg-[#007ac2] shadow-md z-20 flex-shrink-0">
        <div class="max-w-full mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Indonesian Geological Research Explorer</h1>
        </div>
    </header>

    <div id="main-container">
        <div id="top-row" class="flex flex-col md:flex-row overflow-hidden">
            <div id="map-container" class="w-full h-1/2 md:w-2/3 md:h-full flex-shrink-0">
                <div id="map"></div>
            </div>
            <!-- Horizontal Resizer -->
            <div id="resizer-h" class="resizer-h hidden md:block"></div>
            <div id="info-panel-container" class="w-full h-1/2 md:w-1/3 md:h-auto bg-white p-6 overflow-y-auto border-t md:border-t-0 md:border-l border-gray-200">
                <div id="info-panel" class="h-full">
                    <div class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        <h2 class="text-lg font-semibold">Select a data point</h2>
                        <p>Click a marker or table row to view details.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vertical Resizer -->
        <div id="resizer-v" class="resizer-v"></div>

        <div id="table-container-wrapper" class="border-t-2 border-gray-200">
             <!-- Filter Controls -->
             <div class="bg-gray-50 border-b p-4">
                <button id="filter-toggle" class="w-full bg-gray-200 text-gray-700 p-2 rounded-md hover:bg-gray-300 md:hidden flex justify-between items-center">
                    <span>Show Filters</span>
                    <svg id="filter-arrow" class="w-4 h-4 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                <div id="filter-controls" class="hidden md:grid grid-cols-1 md:grid-cols-5 gap-4 pt-4 md:pt-0">
                    <select id="author-filter" class="w-full p-2 border rounded-md"><option value="">Filter by Author...</option></select>
                    <select id="method-filter" class="w-full p-2 border rounded-md"><option value="">Filter by Method...</option></select>
                    <input type="text" id="keyword-search" placeholder="Search in summary..." class="w-full p-2 border rounded-md md:col-span-2">
                    <button id="clear-filters" class="w-full bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600">Clear</button>
                </div>
            </div>
            <div id="table-container" class="flex-grow overflow-auto p-4">
                <table id="data-table" class="display" style="width:100%">
                    <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Method</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let allData = [], allMarkers = {}, dataTable;
            let allUniqueAuthors = [], allUniqueMethods = [];
            const infoPanel = document.getElementById('info-panel');
            
            const map = L.map('map', { center: [-2.5489, 118.0149], zoom: 5 });
            const heatmapLayer = L.heatLayer([], { radius: 25, gradient: { 0.4: '#fdba74', 0.7: '#f97316', 0.9: '#9a3412', 1.0: '#451a03' }});
            const imageMarkersLayer = L.layerGroup();
            
            // --- MAP & LAYERS INITIALIZATION ---
            function initMap() {
                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
                const labels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { attribution: 'Labels &copy; Esri' });
                const hybrid = L.layerGroup([satellite, labels]).addTo(map);
                const baseMaps = { "Hybrid Satellite": hybrid, "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM contributors' }), "Dark Mode": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }) };
                const overlayMaps = { "Heatmap": heatmapLayer, "Image Markers": imageMarkersLayer };
                L.control.layers(baseMaps, overlayMaps).addTo(map);
                imageMarkersLayer.addTo(map);
                heatmapLayer.addTo(map);
            }
            initMap();

            // --- DATA PROCESSING & UI POPULATION ---
            function parseCSV(text) {
                const lines = text.trim().split(/\r?\n/);
                const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/^"|"$/g, ''));
                return lines.slice(1).map(line => {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return headers.reduce((obj, header, i) => {
                        obj[header] = (values[i] || '').trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                        return obj;
                    }, {});
                });
            }

            function populateFilterDropdowns(authors, methods) {
                const authorFilter = $('#author-filter');
                const currentAuthor = authorFilter.val();
                authorFilter.empty().append('<option value="">Filter by Author...</option>');
                authors.forEach(author => authorFilter.append(`<option value="${author}">${author}</option>`));
                if (authors.includes(currentAuthor)) {
                    authorFilter.val(currentAuthor);
                }

                const methodFilter = $('#method-filter');
                const currentMethod = methodFilter.val();
                methodFilter.empty().append('<option value="">Filter by Method...</option>');
                methods.forEach(method => methodFilter.append(`<option value="${method}">${method}</option>`));
                if (methods.includes(currentMethod)) {
                    methodFilter.val(currentMethod);
                }
            }

            function updateInfoPanel(data) {
                const imageName = data['Gambar hasil (petunjuk)'];
                const imagePath = imageName ? `assets/images/${imageName}` : '';
                const imageHTML = imageName ? `<img src="${imagePath}" alt="Research result image" class="w-full h-auto rounded-lg shadow-md mt-1" onerror="this.onerror=null;this.src='https://placehold.co/600x400/EEE/31343C?text=Image+Not+Found';">` : '<p class="text-sm text-gray-500 text-center italic mt-1">No image provided</p>';
                const pdfLinkHTML = data.Link ? `<a href="${data.Link}" target="_blank" class="text-blue-600 hover:underline break-all">View PDF</a>` : '<span>No PDF provided</span>';
                const coordinateKey = 'Koordinat (Lat,Lon)';
                infoPanel.innerHTML = `<div class="space-y-4"><div><h2 class="text-xl font-bold text-gray-800">${data.Judul || 'No Title'}</h2><p class="text-sm text-gray-500 mt-1">By ${data.Penulis || 'Unknown Author'}</p></div><div class="border-t border-gray-200 pt-4"><dl class="space-y-4"><div><dt class="text-sm font-medium text-gray-500">Result Image</dt><dd class="mt-1">${imageHTML}</dd></div><div><dt class="text-sm font-medium text-gray-500">Method</dt><dd class="mt-1 text-md text-gray-800">${data.Metode || 'N/A'}</dd></div><div><dt class="text-sm font-medium text-gray-500">Coordinates</dt><dd class="mt-1 text-md text-gray-800">${data[coordinateKey] || 'N/A'}</dd></div><div><dt class="text-sm font-medium text-gray-500">Summary</dt><dd class="mt-1 text-md text-gray-800 text-justify">${data.Ringkasan || 'No summary available.'}</dd></div><div><dt class="text-sm font-medium text-gray-500">Source Document</dt><dd class="mt-1 text-md">${pdfLinkHTML}</dd></div></dl></div></div>`;
            }

            function updateMapLayers(visibleIdsSet) {
                imageMarkersLayer.clearLayers();
                const newHeatPoints = [];
                allData.forEach(row => {
                    if (visibleIdsSet.has(row.id)) {
                        if (allMarkers[row.id]) imageMarkersLayer.addLayer(allMarkers[row.id]);
                        if (row.lat && row.lon) newHeatPoints.push([row.lat, row.lon, 1]);
                    }
                });
                heatmapLayer.setLatLngs(newHeatPoints);
            }

            // --- DATATABLE & FILTERING LOGIC ---
            function initializeDataTable(tableData) {
                dataTable = $('#data-table').DataTable({
                    data: tableData, columns: [{ title: "ID" }, { title: "Title" }, { title: "Author" }, { title: "Method" }],
                    columnDefs: [{ "visible": false, "targets": 0 }], 
                    paging: true, pageLength: 10,
                    dom: 't<"flex justify-between items-center pt-2"ip>',
                });

                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    const authorFilter = $('#author-filter').val();
                    const methodFilter = $('#method-filter').val();
                    const keywordSearch = $('#keyword-search').val().toLowerCase();
                    const rowData = allData[dataIndex];
                    const authorMatch = !authorFilter || rowData.Penulis === authorFilter;
                    const methodMatch = !methodFilter || rowData.Metode === methodFilter;
                    const keywordMatch = !keywordSearch || (rowData.Ringkasan && rowData.Ringkasan.toLowerCase().includes(keywordSearch));
                    return authorMatch && methodMatch && keywordMatch;
                });

                function updateAndApplyFilters() {
                    const selectedAuthor = $('#author-filter').val();
                    const selectedMethod = $('#method-filter').val();

                    let authorFilteredData = allData;
                    if(selectedMethod) {
                        authorFilteredData = allData.filter(row => row.Metode === selectedMethod);
                    }
                    const relevantAuthors = [...new Set(authorFilteredData.map(row => row.Penulis).filter(Boolean))].sort();

                    let methodFilteredData = allData;
                    if(selectedAuthor) {
                        methodFilteredData = allData.filter(row => row.Penulis === selectedAuthor);
                    }
                    const relevantMethods = [...new Set(methodFilteredData.map(row => row.Metode).filter(Boolean))].sort();

                    populateFilterDropdowns(relevantAuthors, relevantMethods);
                    dataTable.draw();
                }

                $('#author-filter, #method-filter').on('change', updateAndApplyFilters);
                $('#keyword-search').on('keyup', () => dataTable.draw());


                $('#clear-filters').on('click', () => {
                    $('#author-filter, #method-filter, #keyword-search').val('');
                    populateFilterDropdowns(allUniqueAuthors, allUniqueMethods);
                    dataTable.draw();
                });
            }

            // --- MAIN DATA FETCH & APPLICATION START ---
            fetch('Data Web Hanif - Sheet1.csv')
                .then(response => response.text())
                .then(csvText => {
                    allData = parseCSV(csvText);
                    const allPoints = [];
                    const tableData = [];
                    
                    allUniqueAuthors = [...new Set(allData.map(item => item.Penulis).filter(Boolean))].sort();
                    allUniqueMethods = [...new Set(allData.map(item => item.Metode).filter(Boolean))].sort();
                    populateFilterDropdowns(allUniqueAuthors, allUniqueMethods);

                    allData.forEach((row, index) => {
                        row.id = index;
                        const coordsString = row['Koordinat (Lat,Lon)'];
                        if (coordsString) {
                            const [lat, lon] = coordsString.split(',').map(Number);
                            if (!isNaN(lat) && !isNaN(lon)) {
                                row.lat = lat; row.lon = lon;
                                allPoints.push([lat, lon]);
                                const imageIcon = L.icon({ iconUrl: `assets/images/${row['Gambar hasil (petunjuk)']}`, iconSize: [60, 40], iconAnchor: [30, 20], className: 'rounded-md shadow-lg border-2 border-white' });
                                const marker = L.marker([lat, lon], { icon: imageIcon }).on('click', () => updateInfoPanel(row));
                                allMarkers[row.id] = marker;
                                tableData.push([row.id, row.Judul, row.Penulis, row.Metode]);
                            }
                        }
                    });

                    // Add all markers to the map initially
                    Object.values(allMarkers).forEach(marker => imageMarkersLayer.addLayer(marker));

                    if (allPoints.length > 0) map.fitBounds(L.latLngBounds(allPoints), { padding: [50, 50] });
                    initializeDataTable(tableData);
                    
                    // Trigger initial draw to show all data
                    dataTable.draw();

                    $('#data-table').on('draw.dt', function () {
                        const visibleRows = dataTable.rows({ filter: 'applied' }).data();
                        const visibleIds = new Set(visibleRows.toArray().map(r => r[0]));
                        updateMapLayers(visibleIds);
                        const filteredPoints = [];
                        visibleIds.forEach(id => {
                            const row = allData.find(d => d.id === id);
                            if (row && row.lat && row.lon) filteredPoints.push([row.lat, row.lon]);
                        });
                        
                        const noFiltersApplied = !$('#author-filter').val() && !$('#method-filter').val() && !$('#keyword-search').val();
                        
                        if (filteredPoints.length > 0) {
                             map.fitBounds(L.latLngBounds(filteredPoints), { padding: [50, 50], maxZoom: 15 });
                        } else if (noFiltersApplied && allPoints.length > 0) {
                             // If filters are cleared but table is empty (e.g. page 2), zoom to all points
                             map.fitBounds(L.latLngBounds(allPoints), { padding: [50, 50] });
                        }
                    });

                    $('#data-table tbody').on('click', 'tr', function () {
                        const rowData = dataTable.row(this).data();
                        if (rowData) {
                            const marker = allMarkers[rowData[0]];
                            if (marker) { map.setView(marker.getLatLng(), 15); marker.fire('click'); }
                        }
                    });
                });

            // --- NEW: COLLAPSIBLE FILTERS & RESIZABLE PANELS ---

            // 1. Collapsible Filters for Mobile
            const filterToggle = document.getElementById('filter-toggle');
            const filterControls = document.getElementById('filter-controls');
            const filterArrow = document.getElementById('filter-arrow');
            const filterToggleText = filterToggle.querySelector('span');

            filterToggle.addEventListener('click', () => {
                const isHidden = filterControls.classList.contains('hidden');
                filterControls.classList.toggle('hidden');
                filterArrow.classList.toggle('rotate-180');
                filterToggleText.textContent = isHidden ? 'Hide Filters' : 'Show Filters';
            });
            
            // 2. Resizable Panels
            const topRow = document.getElementById('top-row');
            const tableWrapper = document.getElementById('table-container-wrapper');
            const mapContainer = document.getElementById('map-container');
            const infoPanelContainer = document.getElementById('info-panel-container');
            const resizerV = document.getElementById('resizer-v');
            const resizerH = document.getElementById('resizer-h');
            
            // Set initial heights
            topRow.style.height = '60vh';
            tableWrapper.style.height = 'calc(40vh - 56px - 8px)'; // 40vh - header - resizer

            // Vertical Resizer
            resizerV.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.body.style.cursor = 'row-resize';
                window.addEventListener('mousemove', resizeV);
                window.addEventListener('mouseup', stopResizeV);
            });

            function resizeV(e) {
                const mainContainerHeight = document.getElementById('main-container').offsetHeight;
                let newTopHeight = e.clientY - topRow.getBoundingClientRect().top;
                
                // Constraints
                if (newTopHeight < 100) newTopHeight = 100; // Min top height
                if (newTopHeight > mainContainerHeight - 150) newTopHeight = mainContainerHeight - 150; // Min bottom height

                topRow.style.height = `${newTopHeight}px`;
                tableWrapper.style.height = `calc(${mainContainerHeight - newTopHeight - resizerV.offsetHeight}px)`;
                map.invalidateSize(); // Important for Leaflet
            }

            function stopResizeV() {
                document.body.style.cursor = 'default';
                window.removeEventListener('mousemove', resizeV);
                window.removeEventListener('mouseup', stopResizeV);
            }

            // Horizontal Resizer
            resizerH.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.body.style.cursor = 'col-resize';
                window.addEventListener('mousemove', resizeH);
                window.addEventListener('mouseup', stopResizeH);
            });
            
            function resizeH(e) {
                const topRowWidth = topRow.offsetWidth;
                let newMapWidth = e.clientX - topRow.getBoundingClientRect().left;

                // Constraints
                if (newMapWidth < 200) newMapWidth = 200; // Min map width
                if (newMapWidth > topRowWidth - 200) newMapWidth = topRowWidth - 200; // Min info panel width

                mapContainer.style.width = `${newMapWidth}px`;
                infoPanelContainer.style.width = `calc(${topRowWidth - newMapWidth - resizerH.offsetWidth}px)`;
                map.invalidateSize(); // Important for Leaflet
            }
            
            function stopResizeH() {
                document.body.style.cursor = 'default';
                window.removeEventListener('mousemove', resizeH);
                window.removeEventListener('mouseup', stopResizeH);
            }
        });
    </script>
</body>
</html>

